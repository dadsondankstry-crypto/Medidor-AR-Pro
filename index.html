<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medidor AR Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background-color: #000; }
        #menu-inicial {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999; color: white;
        }
        #ui-controles {
            display: none; position: fixed; bottom: 30px; left: 50%; 
            transform: translateX(-50%); z-index: 1000; text-align: center; 
            color: white; background: rgba(0,0,0,0.8); padding: 20px; 
            border-radius: 15px; width: 85%; pointer-events: none; /* Deixa o clique passar para a cena */
        }
        #ui-controles button { pointer-events: auto; } /* Reativa clique só no botão */
        #btn-fechar {
            display: none; position: fixed; top: 20px; right: 20px;
            z-index: 10000; background: #ff4444; color: white; border: none;
            padding: 10px 15px; border-radius: 50%; font-weight: bold;
        }
        .btn-principal {
            background: #008cff; color: white; border: none; padding: 15px 30px;
            border-radius: 30px; font-size: 18px; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="menu-inicial">
        <h1>Medidor AR</h1>
        <button class="btn-principal" onclick="iniciarApp()">ABRIR CÂMERA</button>
    </div>

    <button id="btn-fechar" onclick="fecharApp()">X</button>

    <div id="ui-controles">
        <div id="msg">Toque na tela para o Ponto A</div>
        <button onclick="resetar()" style="margin-top:10px;">Limpar</button>
    </div>

    <a-scene id="cena" embedded arjs="sourceType: webcam; debugUIEnabled: false;" style="display: none;">
        <a-camera id="camera" position="0 0 0"></a-camera>
        <a-entity id="pontos-container"></a-entity>
    </a-scene>

    <script>
        const menu = document.getElementById('menu-inicial');
        const cena = document.getElementById('cena');
        const ui = document.getElementById('ui-controles');
        const btnFechar = document.getElementById('btn-fechar');
        const container = document.querySelector('#pontos-container');
        const display = document.querySelector('#msg');
        
        let pontos = [];

        function iniciarApp() {
            menu.style.display = 'none';
            cena.style.display = 'block';
            ui.style.display = 'block';
            btnFechar.style.display = 'block';
            window.dispatchEvent(new Event('resize'));
        }

        function fecharApp() {
            location.reload();
        }

        // Evento de clique na janela, mas filtrando elementos de UI
        window.addEventListener('touchstart', function (e) {
            if (e.target.tagName === 'BUTTON' || menu.style.display !== 'none') return;

            const camEntity = document.querySelector('#camera');
            const pos = new THREE.Vector3();
            camEntity.object3D.getWorldPosition(pos);
            
            // Clonar a posição atual da câmera para salvar o ponto
            const novaPosicao = pos.clone();
            pontos.push(novaPosicao);

            // Criar a esfera visual no local marcado
            const esfera = document.createElement('a-sphere');
            esfera.setAttribute('position', `${novaPosicao.x} ${novaPosicao.y} ${novaPosicao.z}`);
            esfera.setAttribute('radius', '0.02');
            esfera.setAttribute('color', pontos.length === 1 ? "yellow" : "cyan");
            container.appendChild(esfera);

            if (pontos.length === 1) {
                display.innerHTML = "Ponto A marcado!<br>Mova o celular e toque para o Ponto B";
            } 
            else if (pontos.length === 2) {
                const p1 = pontos[0];
                const p2 = pontos[1];
                const d = p1.distanceTo(p2);
                display.innerHTML = `<strong>Resultado: ${d.toFixed(2)} metros</strong><br>Toque para medir novamente`;
                // Opcional: desenha uma linha entre eles
                const linha = document.createElement('a-entity');
                linha.setAttribute('line', {
                    start: `${p1.x} ${p1.y} ${p1.z}`,
                    end: `${p2.x} ${p2.y} ${p2.z}`,
                    color: 'white'
                });
                container.appendChild(linha);
            } else {
                // Se clicar uma terceira vez, ele reseta e começa novo Ponto A
                resetar();
                // Adiciona o novo Ponto A imediatamente
                pontos.push(novaPosicao);
                container.appendChild(esfera);
                display.innerHTML = "Ponto A marcado!";
            }
        });

        function resetar() {
            pontos = [];
            container.innerHTML = '';
            display.innerText = "Toque para marcar o Ponto A";
        }
    </script>
</body>
</html>