<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Medidor AR Preciso</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <style>
        /* Estilos para deixar bonito e fixo na tela */
        body { font-family: sans-serif; margin: 0; overflow: hidden; }
        
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10; display: flex; flex-direction: column;
            justify-content: space-between; align-items: center;
        }

        #info-topo {
            margin-top: 20px; background: rgba(0,0,0,0.7); color: #0f0;
            padding: 15px 30px; border-radius: 30px; font-size: 24px; font-weight: bold;
            border: 2px solid #0f0; pointer-events: auto;
        }

        #instrucao {
            color: white; background: rgba(0,0,0,0.5); padding: 5px 10px;
            border-radius: 5px; margin-top: 5px; font-size: 14px;
        }

        #botao-acao {
            margin-bottom: 50px; background: white; border: none;
            width: 80px; height: 80px; border-radius: 50%;
            box-shadow: 0 0 10px rgba(255,255,255,0.5); pointer-events: auto;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* Círculo interno do botão para parecer obturador de câmera */
        #botao-acao::after {
            content: ''; width: 60px; height: 60px;
            background: #ff4444; border-radius: 50%; border: 2px solid #333;
        }

        #btn-limpar {
            position: absolute; top: 20px; right: 20px; pointer-events: auto;
            background: #ff4444; color: white; border: none; padding: 10px;
            border-radius: 5px; font-weight: bold;
        }
    </style>

    <script>
        // COMPONENTE MÁGICO: Esse script faz a mira "grudar" no chão real
        AFRAME.registerComponent('ar-hit-test', {
            init: function () {
                this.xrHitTestSource = null;
                this.viewerSpace = null;
                this.refSpace = null;

                this.el.sceneEl.renderer.xr.addEventListener('sessionstart', (ev) => {
                    this.viewerSpace = ev.target.getReferenceSpace('viewer');
                    this.refSpace = ev.target.getReferenceSpace('local');
                    this.requestHitTestSource();
                });

                this.el.sceneEl.renderer.xr.addEventListener('sessionend', () => {
                    this.xrHitTestSource = null;
                });
            },
            requestHitTestSource: function () {
                const session = this.el.sceneEl.renderer.xr.getSession();
                session.requestReferenceSpace('viewer').then((space) => {
                    session.requestHitTestSource({ space }).then((source) => {
                        this.xrHitTestSource = source;
                    });
                });
            },
            tick: function () {
                if (!this.xrHitTestSource) return;
                const frame = this.el.sceneEl.frame;
                if (!frame) return;

                // Pede ao Android para testar colisão com o mundo real
                const hitTestResults = frame.getHitTestResults(this.xrHitTestSource);

                if (hitTestResults.length > 0) {
                    const pose = hitTestResults[0].getPose(this.refSpace);
                    this.el.setAttribute('visible', true);
                    this.el.object3D.position.copy(pose.transform.position);
                    this.el.object3D.quaternion.copy(pose.transform.orientation);
                } else {
                    this.el.setAttribute('visible', false);
                }
            }
        });
    </script>
</head>
<body>

    <div id="overlay">
        <div style="text-align:center;">
            <div id="info-topo">0.00 m</div>
            <div id="instrucao">Procure uma superfície bem iluminada</div>
        </div>
        
        <button id="btn-limpar" onclick="limpar()">Limpar</button>

        <button id="botao-acao" onclick="marcarPonto()"></button>
    </div>

    <a-scene webxr="optionalFeatures: hit-test; overlayElement: #overlay" background="color: transparent">
        
        <a-entity id="mira" ar-hit-test visible="false">
            <a-ring color="white" radius-inner="0.05" radius-outer="0.06" rotation="-90 0 0"></a-ring>
            <a-circle color="white" radius="0.01" rotation="-90 0 0"></a-circle>
        </a-entity>

        <a-entity id="marcacoes"></a-entity>

        <a-entity id="linha" line="color: #0f0; opacity: 1"></a-entity>

    </a-scene>

    <script>
        let pontos = [];
        const mira = document.getElementById('mira');
        const marcacoes = document.getElementById('marcacoes');
        const display = document.getElementById('info-topo');
        const instrucao = document.getElementById('instrucao');
        const linha = document.getElementById('linha');

        function marcarPonto() {
            // Só marca se a mira estiver visível (grudada no chão)
            if (!mira.getAttribute('visible')) {
                alert("Aponte para o chão até aparecer o círculo branco!");
                return;
            }

            // Pega a posição exata da mira no mundo real
            const posicao = mira.object3D.position.clone();
            
            // Adiciona ponto visual
            const esfera = document.createElement('a-sphere');
            esfera.setAttribute('position', posicao);
            esfera.setAttribute('radius', '0.02');
            esfera.setAttribute('color', pontos.length === 0 ? 'yellow' : 'red');
            marcacoes.appendChild(esfera);

            pontos.push(posicao);

            if (pontos.length === 1) {
                instrucao.innerText = "Agora caminhe até o Ponto B e clique";
                // Inicia loop para desenhar linha elástica
                medirTempoReal();
            } 
            else if (pontos.length === 2) {
                // Finaliza medição
                const d = pontos[0].distanceTo(pontos[1]);
                display.innerText = d.toFixed(2) + " m";
                instrucao.innerText = "Medição concluída!";
                desenharLinha(pontos[0], pontos[1]);
            }
        }

        // Função que atualiza a distância enquanto você mexe o celular
        function medirTempoReal() {
            if (pontos.length !== 1) return;
            
            requestAnimationFrame(medirTempoReal);
            
            if (mira.getAttribute('visible')) {
                const p1 = pontos[0];
                const p2 = mira.object3D.position;
                
                // Atualiza o texto
                const d = p1.distanceTo(p2);
                display.innerText = d.toFixed(2) + " m";

                // Atualiza a linha visual
                linha.setAttribute('line', `start: ${p1.x} ${p1.y} ${p1.z}; end: ${p2.x} ${p2.y} ${p2.z}`);
            }
        }

        function desenharLinha(p1, p2) {
            linha.setAttribute('line', `start: ${p1.x} ${p1.y} ${p1.z}; end: ${p2.x} ${p2.y} ${p2.z}`);
        }

        function limpar() {
            pontos = [];
            marcacoes.innerHTML = '';
            linha.removeAttribute('line');
            display.innerText = "0.00 m";
            instrucao.innerText = "Aponte para o chão para começar";
        }
    </script>
</body>
</html>