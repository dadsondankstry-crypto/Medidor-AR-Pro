<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medidor AR Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background-color: #000; }
        
        /* Menu Inicial */
        #menu-inicial {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999; color: white;
        }

        /* Interface de Medição (Invisível no início) */
        #ui-controles {
            display: none; position: fixed; bottom: 30px; left: 50%; 
            transform: translateX(-50%); z-index: 1000; text-align: center; 
            color: white; background: rgba(0,0,0,0.8); padding: 20px; 
            border-radius: 15px; width: 85%;
        }

        /* Botão para Sair/Fechar */
        #btn-fechar {
            display: none; position: fixed; top: 20px; right: 20px;
            z-index: 10000; background: #ff4444; color: white; border: none;
            padding: 10px 15px; border-radius: 50%; font-weight: bold;
        }

        .btn-principal {
            background: #008cff; color: white; border: none; padding: 15px 30px;
            border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="menu-inicial">
        <h1>Medidor AR</h1>
        <p>Pronto para medir?</p>
        <button class="btn-principal" onclick="iniciarApp()">ABRIR CÂMERA</button>
    </div>

    <button id="btn-fechar" onclick="fecharApp()">X</button>

    <div id="ui-controles">
        <div id="msg">Toque na tela para marcar o Ponto A</div>
        <button onclick="resetar()" style="margin-top:10px; background:#444; color:white; border:none; padding:5px 15px; border-radius:5px;">Limpar</button>
    </div>

    <a-scene id="cena" embedded arjs="sourceType: webcam; debugUIEnabled: false;" style="display: none;">
        <a-camera position="0 0 0"></a-camera>
        <a-entity id="pontos-container"></a-entity>
    </a-scene>

    <script>
        const menu = document.getElementById('menu-inicial');
        const cena = document.getElementById('cena');
        const ui = document.getElementById('ui-controles');
        const btnFechar = document.getElementById('btn-fechar');
        const container = document.querySelector('#pontos-container');
        const display = document.querySelector('#msg');
        let pontos = [];

        function iniciarApp() {
            menu.style.display = 'none';
            cena.style.display = 'block';
            ui.style.display = 'block';
            btnFechar.style.display = 'block';
            
            // Força o redimensionamento da câmera AR
            window.dispatchEvent(new Event('resize'));
        }

        function fecharApp() {
            // Recarrega a página para resetar a câmera e sensores completamente
            location.reload();
        }

        window.addEventListener('click', function (e) {
            // Evita marcar ponto se clicar nos botões da interface
            if (e.target.tagName === 'BUTTON') return;
            if (menu.style.display === 'none') {
                const camera = document.querySelector('a-camera');
                const posicao = new THREE.Vector3();
                camera.object3D.getWorldPosition(posicao);
                
                const esfera = document.createElement('a-sphere');
                esfera.setAttribute('position', `${posicao.x} ${posicao.y} ${posicao.z}`);
                esfera.setAttribute('radius', '0.03');
                esfera.setAttribute('color', '#00ff00');
                container.appendChild(esfera);
                
                pontos.push(posicao.clone());

                if (pontos.length >= 2) {
                    const p1 = pontos[pontos.length - 2];
                    const p2 = pontos[pontos.length - 1];
                    const dist = p1.distanceTo(p2);
                    display.innerHTML = `<strong>Distância: ${dist.toFixed(2)}m</strong>`;
                }
            }
        });

        function resetar() {
            pontos = [];
            container.innerHTML = '';
            display.innerText = "Toque para marcar o Ponto A";
        }
    </script>
</body>
</html>