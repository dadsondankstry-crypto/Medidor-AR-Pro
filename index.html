<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Medidor AR Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #000; touch-action: none; }
        
        /* Centralizar tudo e garantir que caiba na tela do celular */
        #menu-inicial {
            position: fixed; inset: 0; background: #111; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; z-index: 9999; color: white;
        }

        /* Painel Superior de Informações */
        #display-info {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8);
            color: #00ff00; padding: 15px; text-align: center; font-size: 20px;
            font-weight: bold; z-index: 1000; border-bottom: 2px solid #00ff00;
            display: none;
        }

        /* Botão de Ação Principal (Embaixo) */
        #controles-inferiores {
            position: fixed; bottom: 40px; left: 0; width: 100%;
            display: none; flex-direction: column; align-items: center; z-index: 1000;
        }

        .btn-acao {
            background: #008cff; color: white; border: none; padding: 20px 40px;
            border-radius: 50px; font-size: 18px; font-weight: bold; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 80%;
        }

        .btn-reset {
            background: #444; color: #ccc; border: none; padding: 10px;
            margin-top: 15px; border-radius: 5px; width: 40%;
        }

        #btn-fechar {
            position: fixed; top: 70px; right: 10px; z-index: 1001;
            background: #ff4444; color: white; border: none; padding: 10px;
            border-radius: 5px; display: none;
        }
    </style>
</head>
<body>

    <div id="menu-inicial">
        <h1 style="margin-bottom: 20px;">MEDIDOR AR</h1>
        <button class="btn-acao" onclick="iniciarApp()">ABRIR CÂMERA</button>
    </div>

    <div id="display-info">Pronto para medir</div>
    <button id="btn-fechar" onclick="location.reload()">Sair</button>

    <div id="controles-inferiores">
        <button id="btn-principal" class="btn-acao" onclick="processarClique()">MARCAR PONTO A</button>
        <button class="btn-reset" onclick="resetar()">Limpar Tudo</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" style="display: none;" id="cena">
        <a-camera id="camera" position="0 0 0">
            <a-entity cursor="fuse: false" position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: white; shader: flat">
            </a-entity>
        </a-camera>
        
        <a-entity id="elementos-ar"></a-entity>
        <a-entity id="linha-guia" line="color: yellow; opacity: 0.7"></a-entity>
    </a-scene>

    <script>
        let pontos = [];
        const info = document.getElementById('display-info');
        const btnPrincipal = document.getElementById('btn-principal');
        const elementos = document.querySelector('#elementos-ar');
        const linhaGuia = document.querySelector('#linha-guia');
        const camera = document.querySelector('#camera');

        function iniciarApp() {
            document.getElementById('menu-inicial').style.display = 'none';
            document.getElementById('cena').style.display = 'block';
            document.getElementById('display-info').style.display = 'block';
            document.getElementById('controles-inferiores').style.display = 'flex';
            document.getElementById('btn-fechar').style.display = 'block';
            window.dispatchEvent(new Event('resize'));
        }

        // Loop de animação para a linha seguir a câmera
        function update() {
            if (pontos.length === 1) {
                const posCam = new THREE.Vector3();
                camera.object3D.getWorldPosition(posCam);
                const p1 = pontos[0];
                
                linhaGuia.setAttribute('line', {
                    start: `${p1.x} ${p1.y} ${p1.z}`,
                    end: `${posCam.x} ${posCam.y} ${posCam.z}`
                });

                // Atualiza distância em tempo real no topo
                const distAtual = p1.distanceTo(posCam);
                info.innerText = `Medindo: ${distAtual.toFixed(2)}m`;
            }
            requestAnimationFrame(update);
        }
        update();

        function processarClique() {
            const posAtual = new THREE.Vector3();
            camera.object3D.getWorldPosition(posAtual);
            const pontoMarcado = posAtual.clone();

            if (pontos.length === 0) {
                // Marcou Ponto A
                pontos.push(pontoMarcado);
                criarEsfera(pontoMarcado, "yellow");
                btnPrincipal.innerText = "MARCAR PONTO B";
                btnPrincipal.style.background = "#28a745";
                info.innerText = "Ponto A fixado. Mova-se!";
            } 
            else if (pontos.length === 1) {
                // Marcou Ponto B
                pontos.push(pontoMarcado);
                criarEsfera(pontoMarcado, "#00ff00");
                
                const d = pontos[0].distanceTo(pontos[1]);
                info.innerHTML = `DISTÂNCIA FINAL: ${d.toFixed(2)} metros`;
                
                btnPrincipal.innerText = "MEDIR NOVO";
                btnPrincipal.style.background = "#008cff";
                linhaGuia.setAttribute('line', 'opacity', 0); // Esconde linha guia
                
                // Desenha linha fixa final
                const linhaFinal = document.createElement('a-entity');
                linhaFinal.setAttribute('line', {
                    start: `${pontos[0].x} ${pontos[0].y} ${pontos[0].z}`,
                    end: `${pontos[1].x} ${pontos[1].y} ${pontos[1].z}`,
                    color: '#00ff00'
                });
                elementos.appendChild(linhaFinal);
            } else {
                resetar();
            }
        }

        function criarEsfera(pos, cor) {
            const esfera = document.createElement('a-sphere');
            esfera.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
            esfera.setAttribute('radius', '0.03');
            esfera.setAttribute('color', cor);
            elementos.appendChild(esfera);
        }

        function resetar() {
            pontos = [];
            elementos.innerHTML = '';
            linhaGuia.setAttribute('line', 'opacity', 0.7);
            btnPrincipal.innerText = "MARCAR PONTO A";
            btnPrincipal.style.background = "#008cff";
            info.innerText = "Pronto para medir";
        }
    </script>
</body>
</html>